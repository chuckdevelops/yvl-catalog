{% extends 'catalog/base.html' %}
{% load catalog_filters %}

{% block title %}{{ song.name }} | Playboi Carti Catalog{% endblock %}

{% block content %}
<div class="container">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'catalog:index' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'catalog:song_list' %}">Songs</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ song.name }}</li>
        </ol>
    </nav>

    <div class="card mb-4">
        <div class="card-header bg-dark text-white">
            <h1 class="h3 mb-0">{{ song.name }}
                {% if song.file_date == 'Album Track' %}
                    <span class="badge bg-secondary">Official Album Track</span>
                {% endif %}
            </h1>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <table class="table">
                        <tr>
                            <th style="width: 150px;">Era:</th>
                            <td>{{ song.era }}</td>
                        </tr>
                        <tr>
                            <th>Categories:</th>
                            <td>
                                {% if song.primary_tab_name and song.primary_tab_name != "Unknown" %}
                                    <!-- Show primary tab (Released/Unreleased) first -->
                                    <div class="mb-2">
                                        <span class="badge bg-primary">{{ song.primary_tab_name }}</span>
                                        
                                        <!-- Use custom filter to handle AI badges -->
                                        {% load catalog_filters %}
                                        {% for tab in song.emoji_tab_names|filter_ai_badge:song.name %}
                                            <span class="badge bg-info">{{ tab }}</span>
                                        {% empty %}
                                            <!-- No emoji tabs -->
                                        {% endfor %}
                                    </div>
                                    
                                    <!-- Show other tabs if any exist -->
                                    {% if song.other_tab_names %}
                                        <div>
                                            <strong>Additional Categories:</strong><br>
                                            {% for tab in song.other_tab_names %}
                                                <span class="badge bg-secondary">{{ tab }}</span>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <em>Unknown</em>
                                {% endif %}
                            </td>
                        </tr>
                        {% if song.subsection_name %}
                        <tr>
                            <th>Subsection:</th>
                            <td>{{ song.subsection_name }}</td>
                        </tr>
                        {% endif %}
                        <tr>
                            <th>Type:</th>
                            <td>{% if song.type and song.type != "NaN" and song.type != "nan" %}{{ song.type|format_type }}{% else %}<em></em>{% endif %}</td>
                        </tr>
                        <tr>
                            <th>Quality:</th>
                            <td>{% if song.quality and song.quality != "NaN" and song.quality != "nan" %}{{ song.quality }}{% else %}<em></em>{% endif %}</td>
                        </tr>
                        <tr>
                            <th>Track Length:</th>
                            <td>{% if song.track_length and song.track_length != "NaN" and song.track_length != "nan" %}{{ song.track_length }}{% else %}<em></em>{% endif %}</td>
                        </tr>
                        {% if song.display_album_name %}
                        <tr>
                            <th>Album:</th>
                            <td>{{ song.display_album_name }}</td>
                        </tr>
                        {% endif %}
                        {% if song.display_track_number %}
                        <tr>
                            <th>Album Track #:</th>
                            <td>{{ song.display_track_number }}</td>
                        </tr>
                        {% endif %}
                        <tr>
                            <th>Leak Date:</th>
                            <td>{% if song.leak_date and song.leak_date != "NaN" and song.leak_date != "nan" %}{{ song.leak_date }}{% else %}<em></em>{% endif %}</td>
                        </tr>
                        <tr>
                            <th>File:</th>
                            <td>{% if song.file_date and song.file_date != "NaN" and song.file_date != "nan" %}{{ song.file_date }}{% else %}<em></em>{% endif %}</td>
                        </tr>
                        <tr>
                            <th>Available Length:</th>
                            <td>{% if song.available_length and song.available_length != "NaN" and song.available_length != "nan" %}{{ song.available_length|remove_urls }}{% else %}<em></em>{% endif %}</td>
                        </tr>
                    </table>

                    {% if song.links %}
                    <div class="mt-4">
                        <h4>Links</h4>
                        <p>{{ song.links|urlize }}</p>
                    </div>
                    {% endif %}
                    
                    {% if song.notes %}
                    <div class="mt-4">
                        <h4>Notes</h4>
                        <div class="card">
                            <div class="card-body bg-light">
                                {{ song.notes|linebreaks }}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <div class="col-md-4">
                    <!-- Similar Songs -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5>Similar Songs</h5>
                        </div>
                        <div class="card-body">
                            <div class="list-group">
                                {% for related in related_songs %}
                                <a href="{% url 'catalog:song_detail' song_id=related.id %}" class="list-group-item list-group-item-action">
                                    {{ related.name }}
                                </a>
                                {% empty %}
                                <p class="text-muted">No related songs found.</p>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Voting Card -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row text-center" id="voting-section">
                                <div class="col-6">
                                    <button id="like-btn" class="btn btn-outline-secondary mb-2 w-100 {% if user_vote == 'like' %}active{% endif %}" 
                                            data-vote-type="like" data-song-id="{{ song.id }}">
                                        <i class="fas fa-thumbs-up"></i>
                                    </button>
                                    <div class="like-count">{{ like_count }}</div>
                                </div>
                                <div class="col-6">
                                    <button id="dislike-btn" class="btn btn-outline-secondary mb-2 w-100 {% if user_vote == 'dislike' %}active{% endif %}" 
                                            data-vote-type="dislike" data-song-id="{{ song.id }}">
                                        <i class="fas fa-thumbs-down"></i>
                                    </button>
                                    <div class="dislike-count">{{ dislike_count }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bookmark Card -->
                    <div class="card">
                        <div class="card-header">
                            <h5>Bookmark Song</h5>
                        </div>
                        <div class="card-body">
                            <!-- Banner display (shows which collections this song is in) -->
                            <div id="collection-banners" class="mb-3"></div>
                            
                            <!-- Bookmark form -->
                            <div class="input-group mb-3">
                                <input type="text" id="collection-name" class="form-control" placeholder="Collection name" value="My Collection">
                                <button id="bookmark-btn" class="btn btn-primary" data-song-id="{{ song.id }}">
                                    <i class="fas fa-bookmark"></i> Save
                                </button>
                            </div>
                            
                            <!-- Link to view all bookmarks -->
                            <div class="text-center mt-3">
                                <a href="#" id="view-bookmarks-link" class="text-decoration-none">
                                    <small>View all your bookmarks</small>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Fixed event listener - correctly spelled DOMContentLoaded
    document.addEventListener('DOMContentLoaded', function() {
        const songId = "{{ song.id }}";
        const voteButtons = document.querySelectorAll('#like-btn, #dislike-btn');
        const bookmarkBtn = document.getElementById('bookmark-btn');
        const collectionNameInput = document.getElementById('collection-name');
        const collectionBannersContainer = document.getElementById('collection-banners');
        const viewBookmarksLink = document.getElementById('view-bookmarks-link');
        
        // Check localStorage for saved votes and pre-set button state
        function checkSavedVotes() {
            // Get saved votes from localStorage
            const savedVotes = JSON.parse(localStorage.getItem('cartiCatalogVotes') || '{}');
            
            // If this song has a saved vote, update UI
            if (savedVotes[songId]) {
                const savedVoteType = savedVotes[songId];
                
                // Pre-select the right button (if server didn't already set it)
                if (!document.querySelector('.btn.active')) {
                    document.querySelector(`#${savedVoteType}-btn`).classList.add('active');
                }
            }
        }
        
        // Save vote to localStorage
        function saveVoteToLocalStorage(songId, voteType) {
            // Get existing votes or initialize empty object
            const savedVotes = JSON.parse(localStorage.getItem('cartiCatalogVotes') || '{}');
            
            if (voteType === null) {
                // If vote was removed, delete from localStorage
                delete savedVotes[songId];
            } else {
                // Update with new vote
                savedVotes[songId] = voteType;
            }
            
            // Save back to localStorage
            localStorage.setItem('cartiCatalogVotes', JSON.stringify(savedVotes));
        }
        
        // Handle vote button clicks
        voteButtons.forEach(button => {
            button.addEventListener('click', function() {
                const songId = this.dataset.songId;
                const voteType = this.dataset.voteType;
                
                // Prepare form data
                const formData = new FormData();
                formData.append('vote_type', voteType);
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                
                // Send vote to server
                fetch(`/songs/${songId}/vote/`, {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Update counts
                        document.querySelector('.like-count').textContent = data.like_count;
                        document.querySelector('.dislike-count').textContent = data.dislike_count;
                        
                        // Update active state of buttons
                        document.getElementById('like-btn').classList.toggle('active', data.user_vote === 'like');
                        document.getElementById('dislike-btn').classList.toggle('active', data.user_vote === 'dislike');
                        
                        // Save to localStorage
                        saveVoteToLocalStorage(songId, data.user_vote);
                    } else if (data.status === 'error') {
                        // Show error message
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            });
        });
        
        // ----- BOOKMARKS FUNCTIONALITY -----
        
        // Check localStorage for existing bookmarks
        function checkSavedBookmarks() {
            // Get bookmarks data from server for this song
            fetch(`/bookmarks/?song_id=${songId}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    updateCollectionBanners(data.collections || []);
                }
            })
            .catch(error => {
                console.error('Error checking bookmarks:', error);
            });
        }
        
        // Create banner for each collection
        function updateCollectionBanners(collections) {
            // Clear current banners
            collectionBannersContainer.innerHTML = '';
            
            if (collections.length === 0) {
                collectionBannersContainer.innerHTML = '<span class="text-muted">Not in any collection yet</span>';
                return;
            }
            
            // Add collection banners
            collections.forEach(collection => {
                const banner = document.createElement('div');
                banner.className = 'badge bg-info me-2 mb-2 p-2 d-inline-flex align-items-center';
                banner.innerHTML = `
                    <span>${collection}</span>
                    <button type="button" class="ms-2 p-1 rounded-circle bg-danger text-white border-0" 
                        style="width: 16px; height: 16px; font-size: 10px; line-height: 1; display: inline-flex; align-items: center; justify-content: center;"
                        aria-label="Remove from ${collection}" 
                        data-collection="${collection}">
                        ✕
                    </button>
                `;
                collectionBannersContainer.appendChild(banner);
                
                // Add remove handler to the close button
                const closeBtn = banner.querySelector('button');
                closeBtn.addEventListener('click', function() {
                    removeFromCollection(this.dataset.collection);
                });
            });
        }
        
        // Handle bookmark button click
        if (bookmarkBtn) {
            bookmarkBtn.addEventListener('click', function() {
                const songId = this.dataset.songId;
                const collectionName = collectionNameInput.value.trim() || 'My Collection';
                
                // Prepare form data
                const formData = new FormData();
                formData.append('collection_name', collectionName);
                formData.append('action', 'add');
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                
                // Send bookmark to server
                fetch(`/songs/${songId}/bookmark/`, {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Update collection banners
                        updateCollectionBanners(data.collections);
                        // Clear the input after successful add
                        collectionNameInput.value = '';
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            });
        }
        
        // Remove from collection
        function removeFromCollection(collectionName) {
            // Prepare form data
            const formData = new FormData();
            formData.append('collection_name', collectionName);
            formData.append('action', 'remove');
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            
            // Send remove request to server
            fetch(`/songs/${songId}/bookmark/`, {
                method: 'POST',
                body: formData,
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Update collection banners
                    updateCollectionBanners(data.collections);
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
        
        // Set up view bookmarks link
        if (viewBookmarksLink) {
            viewBookmarksLink.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Open a modal or redirect to a bookmarks page
                // For simplicity, we'll create a basic modal with bookmarks
                showBookmarksModal();
            });
        }
        
        // Create and show bookmarks modal
        function showBookmarksModal() {
            // Create modal container if it doesn't exist
            let modal = document.getElementById('bookmarks-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'bookmarks-modal';
                modal.className = 'modal fade';
                modal.setAttribute('tabindex', '-1');
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Your Bookmarked Songs</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <select id="collection-filter" class="form-select">
                                        <option value="">All Collections</option>
                                    </select>
                                </div>
                                <div id="bookmarks-list" class="list-group">
                                    <div class="text-center">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Initialize the Bootstrap modal
                const modalObj = new bootstrap.Modal(modal);
                modal._bsModal = modalObj;
                
                // Set up collection filter change handler
                const collectionFilter = modal.querySelector('#collection-filter');
                collectionFilter.addEventListener('change', function() {
                    loadBookmarks(this.value);
                });
            }
            
            // Show the modal
            modal._bsModal.show();
            
            // Load collections and bookmarks
            loadCollections();
            loadBookmarks();
        }
        
        // Load collections for the filter dropdown
        function loadCollections() {
            fetch('/collections/')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const collectionFilter = document.getElementById('collection-filter');
                    
                    // Clear existing options except the first one
                    while (collectionFilter.options.length > 1) {
                        collectionFilter.remove(1);
                    }
                    
                    // Add options for each collection
                    data.collections.forEach(collection => {
                        const option = document.createElement('option');
                        option.value = collection.collection_name;
                        option.textContent = `${collection.collection_name} (${collection.count})`;
                        collectionFilter.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading collections:', error);
            });
        }
        
        // Load bookmarks
        function loadBookmarks(collection = '') {
            const bookmarksList = document.getElementById('bookmarks-list');
            bookmarksList.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;
            
            const url = collection ? `/bookmarks/?collection=${encodeURIComponent(collection)}` : '/bookmarks/';
            
            fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    bookmarksList.innerHTML = '';
                    
                    if (data.bookmarks.length === 0) {
                        bookmarksList.innerHTML = '<p class="text-center text-muted">No bookmarks found</p>';
                        return;
                    }
                    
                    // Add each bookmark to the list
                    data.bookmarks.forEach(bookmark => {
                        const item = document.createElement('a');
                        item.href = `/songs/${bookmark.id}/`;
                        item.className = 'list-group-item list-group-item-action';
                        
                        let primaryTab = '';
                        if (bookmark.primary_tab) {
                            primaryTab = `<span class="badge bg-primary">${bookmark.primary_tab}</span> `;
                        }
                        
                        item.innerHTML = `
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">${bookmark.name}</h5>
                                <small>${bookmark.era || 'Unknown Era'}</small>
                            </div>
                            <div class="d-flex w-100 justify-content-between">
                                <div>
                                    ${primaryTab}
                                    <span class="badge bg-info d-inline-flex align-items-center">
                                        <span>${bookmark.collection}</span>
                                        <button type="button" class="ms-1 p-1 rounded-circle bg-danger text-white border-0" 
                                            style="width: 14px; height: 14px; font-size: 8px; line-height: 1; display: inline-flex; align-items: center; justify-content: center;"
                                            aria-label="Remove from ${bookmark.collection}" 
                                            data-song-id="${bookmark.id}" 
                                            data-collection="${bookmark.collection}">
                                            ✕
                                        </button>
                                    </span>
                                </div>
                            </div>
                        `;
                        bookmarksList.appendChild(item);
                        
                        // Add event listener to the remove button
                        const removeBtn = item.querySelector('button');
                        if (removeBtn) {
                            removeBtn.addEventListener('click', function(e) {
                                e.preventDefault();
                                e.stopPropagation(); // Prevent navigation to song page
                                
                                const songId = this.dataset.songId;
                                const collectionName = this.dataset.collection;
                                
                                // Confirm before removing
                                if (confirm(`Remove "${bookmark.name}" from collection "${collectionName}"?`)) {
                                    removeBookmark(songId, collectionName, () => {
                                        // Refresh the list after removal
                                        loadBookmarks(document.getElementById('collection-filter').value);
                                    });
                                }
                            });
                        }
                    });
                } else {
                    bookmarksList.innerHTML = `<p class="text-center text-danger">${data.message || 'Error loading bookmarks'}</p>`;
                }
            })
            .catch(error => {
                console.error('Error loading bookmarks:', error);
                bookmarksList.innerHTML = '<p class="text-center text-danger">Error loading bookmarks</p>';
            });
        }
        
        // Function to remove a bookmark (used in the modal list)
        function removeBookmark(songId, collectionName, callback) {
            // Prepare form data
            const formData = new FormData();
            formData.append('collection_name', collectionName);
            formData.append('action', 'remove');
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            
            // Send remove request to server
            fetch(`/songs/${songId}/bookmark/`, {
                method: 'POST',
                body: formData,
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // If we're viewing the current song's bookmarks, update the banners
                    if (songId === "{{ song.id }}") {
                        updateCollectionBanners(data.collections);
                    }
                    
                    // Call the callback function if provided
                    if (typeof callback === 'function') {
                        callback();
                    }
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error removing bookmark. Please try again.');
            });
        }
        
        
        // Check for saved votes and bookmarks on page load
        checkSavedVotes();
        checkSavedBookmarks();
    });
</script>
{% endblock %}